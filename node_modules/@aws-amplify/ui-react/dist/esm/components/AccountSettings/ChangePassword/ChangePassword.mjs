import{__awaiter as e}from"tslib";import i from"react";import r from"lodash/isEqual.js";import{Logger as s}from"aws-amplify";import{getDefaultPasswordValidators as t,runFieldValidators as o,getDefaultConfirmPasswordValidators as m,translate as a,changePassword as n}from"@aws-amplify/ui";import{useAuth as l}from"../../../hooks/useAuth.mjs";import"@aws-amplify/datastore";import"@aws-amplify/storage";import"classnames";import"../../../primitives/shared/constants.mjs";import{View as p}from"../../../primitives/View/View.mjs";import"../../../helpers/constants.mjs";import"../../../primitives/Alert/Alert.mjs";import"../../../primitives/Autocomplete/Autocomplete.mjs";import"../../../primitives/Badge/Badge.mjs";import"../../../primitives/Button/Button.mjs";import"../../../primitives/ButtonGroup/ButtonGroup.mjs";import"../../../primitives/Card/Card.mjs";import"../../../primitives/CheckboxField/CheckboxField.mjs";import"../../../primitives/Collection/Collection.mjs";import"../../../primitives/Divider/Divider.mjs";import"../../../primitives/Expander/Expander.mjs";import"../../../primitives/Expander/ExpanderItem.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.mjs";import{Flex as d}from"../../../primitives/Flex/Flex.mjs";import"../../../primitives/Grid/Grid.mjs";import"../../../primitives/Heading/Heading.mjs";import"../../../primitives/HighlightMatch/HighlightMatch.mjs";import"../../../primitives/Icon/Icon.mjs";import"../../../primitives/Image/Image.mjs";import"../../../primitives/Link/Link.mjs";import"../../../primitives/Loader/Loader.mjs";import"../../../primitives/Menu/Menu.mjs";import"../../../primitives/Menu/MenuButton.mjs";import"../../../primitives/Menu/MenuItem.mjs";import"../../../primitives/Pagination/Pagination.mjs";import"../../../primitives/PasswordField/PasswordField.mjs";import"../../../primitives/PhoneNumberField/PhoneNumberField.mjs";import"../../../primitives/Placeholder/Placeholder.mjs";import"../../../primitives/Radio/Radio.mjs";import"../../../primitives/RadioGroupField/RadioGroupField.mjs";import"../../../primitives/Rating/Rating.mjs";import"../../../primitives/ScrollView/ScrollView.mjs";import"../../../primitives/SearchField/SearchField.mjs";import"../../../primitives/SelectField/SelectField.mjs";import"../../../primitives/SliderField/SliderField.mjs";import"../../../primitives/StepperField/StepperField.mjs";import"../../../primitives/SwitchField/SwitchField.mjs";import"../../../primitives/Table/Table.mjs";import"../../../primitives/Table/TableBody.mjs";import"../../../primitives/Table/TableCell.mjs";import"../../../primitives/Table/TableFoot.mjs";import"../../../primitives/Table/TableHead.mjs";import"../../../primitives/Table/TableRow.mjs";import"../../../primitives/Tabs/Tabs.mjs";import"../../../primitives/Text/Text.mjs";import"../../../primitives/TextAreaField/TextAreaField.mjs";import"../../../primitives/TextField/TextField.mjs";import"../../../primitives/ToggleButton/ToggleButton.mjs";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.mjs";import"../../../primitives/VisuallyHidden/VisuallyHidden.mjs";import{ComponentClassName as u}from"../constants.mjs";import c from"./defaults.mjs";const v=new s("ChangePassword");function w({onSuccess:s,onError:w,validators:j,components:g}){const[P,f]=i.useState(null),[F,b]=i.useState({}),[h,T]=i.useState({}),C=i.useRef([]),{user:B,isLoading:S}=l(),E=((e,i)=>{var r,s;const{currentPassword:t,newPassword:o,confirmPassword:m}=e;return!(t&&o&&m)||((null===(r=i.newPassword)||void 0===r?void 0:r.length)>0||(null===(s=i.confirmPassword)||void 0===s?void 0:s.length)>0)})(F,h),y=i.useMemo((()=>null!=j?j:t()),[j]),x=i.useCallback((({formValues:e,eventType:i})=>{const{newPassword:r}=e,s=C.current.includes("newPassword");return o({value:r,validators:y,eventType:i,hasBlurred:s})}),[y]),M=i.useCallback((({formValues:e,eventType:i})=>{const{newPassword:r,confirmPassword:s}=e,t=C.current.includes("confirmPassword"),a=m(r);return o({value:s,validators:a,eventType:i,hasBlurred:t})}),[]),G=i.useCallback((e=>{const i={newPassword:x(e),confirmPassword:M(e)};r(h,i)||T(i)}),[M,x,h]),V=a("Current Password"),R=a("New Password"),I=a("Confirm Password"),k=a("Update password"),{CurrentPasswordField:A,NewPasswordField:H,ConfirmPasswordField:N,SubmitButton:D,ErrorMessage:q}=i.useMemo((()=>Object.assign(Object.assign({},c),null!=g?g:{})),[g]),L=e=>{e.preventDefault();const{name:i,value:r}=e.target,s=Object.assign(Object.assign({},F),{[i]:r});G({formValues:s,eventType:"change"}),b(s)},O=e=>{e.preventDefault();const{name:i}=e.target;if(!C.current.includes(i)){const e=[...C.current,i];C.current=e,G({formValues:F,eventType:"blur"})}};return S?null:B?i.createElement(p,{as:"form",className:u.ChangePassword,onSubmit:i=>e(this,void 0,void 0,(function*(){if(i.preventDefault(),!B)return;const{currentPassword:e,newPassword:r}=F;P&&f(null);try{yield n({user:B,currentPassword:e,newPassword:r}),null==s||s()}catch(e){const i=e;i.message&&f(i.message),null==w||w(i)}}))},i.createElement(d,{direction:"column"},i.createElement(A,{autoComplete:"current-password",isRequired:!0,label:V,name:"currentPassword",onBlur:O,onChange:L}),i.createElement(H,{autoComplete:"new-password",fieldValidationErrors:null==h?void 0:h.newPassword,isRequired:!0,label:R,name:"newPassword",onBlur:O,onChange:L}),i.createElement(N,{autoComplete:"new-password",fieldValidationErrors:null==h?void 0:h.confirmPassword,isRequired:!0,label:I,name:"confirmPassword",onBlur:O,onChange:L}),i.createElement(D,{isDisabled:E,type:"submit"},k),P?i.createElement(q,null,P):null)):(v.warn("<ChangePassword /> requires user to be authenticated."),null)}w.CurrentPasswordField=c.CurrentPasswordField,w.NewPasswordField=c.NewPasswordField,w.ConfirmPasswordField=c.ConfirmPasswordField,w.SubmitButton=c.SubmitButton,w.ErrorMessage=c.ErrorMessage;export{w as default};
