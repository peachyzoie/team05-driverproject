import{__rest as e}from"tslib";import i,{useState as t,useEffect as r,useCallback as s,useMemo as o}from"react";import{Storage as m}from"@aws-amplify/storage";import{translate as l,uploadFile as a,isValidExtension as n}from"@aws-amplify/ui";import{Logger as p}from"aws-amplify";import"../../../primitives/Alert/Alert.mjs";import"../../../primitives/Autocomplete/Autocomplete.mjs";import"../../../primitives/Badge/Badge.mjs";import{Button as c}from"../../../primitives/Button/Button.mjs";import"../../../primitives/ButtonGroup/ButtonGroup.mjs";import"../../../primitives/Card/Card.mjs";import"../../../primitives/CheckboxField/CheckboxField.mjs";import"../../../primitives/Collection/Collection.mjs";import"../../../primitives/Divider/Divider.mjs";import"../../../primitives/Expander/Expander.mjs";import"../../../primitives/Expander/ExpanderItem.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.mjs";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.mjs";import"../../../primitives/Flex/Flex.mjs";import"../../../primitives/Grid/Grid.mjs";import"../../../primitives/Heading/Heading.mjs";import"../../../primitives/HighlightMatch/HighlightMatch.mjs";import"../../../primitives/Icon/Icon.mjs";import"../../../primitives/Image/Image.mjs";import"../../../primitives/Link/Link.mjs";import"../../../primitives/Loader/Loader.mjs";import"../../../primitives/Menu/Menu.mjs";import"../../../primitives/Menu/MenuButton.mjs";import"../../../primitives/Menu/MenuItem.mjs";import"../../../primitives/Pagination/Pagination.mjs";import"../../../primitives/PasswordField/PasswordField.mjs";import"../../../primitives/PhoneNumberField/PhoneNumberField.mjs";import"../../../primitives/Placeholder/Placeholder.mjs";import"../../../primitives/Radio/Radio.mjs";import"../../../primitives/RadioGroupField/RadioGroupField.mjs";import"../../../primitives/Rating/Rating.mjs";import"../../../primitives/ScrollView/ScrollView.mjs";import"../../../primitives/SearchField/SearchField.mjs";import"../../../primitives/SelectField/SelectField.mjs";import"../../../primitives/SliderField/SliderField.mjs";import"../../../primitives/StepperField/StepperField.mjs";import"../../../primitives/SwitchField/SwitchField.mjs";import"../../../primitives/Table/Table.mjs";import"../../../primitives/Table/TableBody.mjs";import"../../../primitives/Table/TableCell.mjs";import"../../../primitives/Table/TableFoot.mjs";import"../../../primitives/Table/TableHead.mjs";import"../../../primitives/Table/TableRow.mjs";import"../../../primitives/Tabs/Tabs.mjs";import"../../../primitives/Text/Text.mjs";import"../../../primitives/TextAreaField/TextAreaField.mjs";import"../../../primitives/TextField/TextField.mjs";import"../../../primitives/ToggleButton/ToggleButton.mjs";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.mjs";import"../../../primitives/View/View.mjs";import{VisuallyHidden as d}from"../../../primitives/VisuallyHidden/VisuallyHidden.mjs";import{ComponentClassNames as u}from"../../../primitives/shared/constants.mjs";import v from"./hooks/useFileUploader/useFileUploader.mjs";import{UploadPreviewer as g}from"./UploadPreviewer/index.mjs";import{UploadDropZone as j}from"./UploadDropZone/index.mjs";import{UploadTracker as f}from"./UploadTracker/index.mjs";import{FileState as b}from"./types.mjs";const F=e=>"function"==typeof(null==e?void 0:e.resume),S=new p("AmplifyUI:Storage");function h(p){var{acceptedFileTypes:h,shouldAutoProceed:T=!1,isPreviewerVisible:E,maxFileCount:w,maxSize:I,hasMultipleFiles:x=!0,onError:C,onSuccess:O,showImages:P=!0,accessLevel:R,variation:k="drop",isResumable:y=!1}=p,M=e(p,["acceptedFileTypes","shouldAutoProceed","isPreviewerVisible","maxFileCount","maxSize","hasMultipleFiles","onError","onSuccess","showImages","accessLevel","variation","isResumable"]);h&&R||S.warn("FileUploader requires accessLevel and acceptedFileTypes props");const[B,G]=t(!1),[A,D]=t(!1),L=v({maxSize:I,acceptedFileTypes:h,hasMultipleFiles:x,isLoading:B,setAutoLoad:D}),{addTargetFiles:N,fileStatuses:U,inDropZone:V,setFileStatuses:H,setShowPreviewer:Z,showPreviewer:z}=L,q=e(L,["addTargetFiles","fileStatuses","inDropZone","setFileStatuses","setShowPreviewer","showPreviewer"]),W=Math.floor(U.reduce(((e,i)=>{var t;return e+(null!==(t=null==i?void 0:i.percentage)&&void 0!==t?t:0)}),0)/U.length),J=0!==U.length&&U.every((e=>100===(null==e?void 0:e.percentage))),K=U.filter((e=>100!==e.percentage)).length>w;r((()=>{100===Math.floor(W)&&G(!1)}),[W]),r((()=>{Z(E)}),[Z,E]);const Q=s((e=>i=>{H((t=>{const r=Object.assign({},t[e]),s=0!==i.total?Math.floor(i.loaded/i.total*100):100,o=100!==s?b.LOADING:b.SUCCESS,m=Object.assign(Object.assign({},r),{percentage:s,fileState:o});return t[e]=m,[...t]}))}),[H]),X=s((e=>i=>{H((t=>{const r=Object.assign({},t[e]),s=Object.assign(Object.assign({},r),{fileState:"error",fileErrors:l(i.toString())});return t[e]=s,[...t]})),G(!1),"function"==typeof C&&C(i)}),[C,H]),Y=s((e=>function(){const i=U[e];F(i.uploadTask)&&i.uploadTask.pause();const t=[...U];t[e]=Object.assign(Object.assign({},i),{fileState:b.PAUSED}),H(t)}),[U,H]),$=s((e=>function(){const i=U[e];F(i.uploadTask)&&i.uploadTask.resume();const t=[...U];t[e]=Object.assign(Object.assign({},i),{fileState:b.RESUME}),H(t)}),[U,H]),_=s((()=>{G(!0);const e=[];U.forEach(((i,t)=>{if((null==i?void 0:i.fileState)===b.SUCCESS)return;const r=a(Object.assign({file:i.file,fileName:i.name,level:R,isResumable:y,progressCallback:Q(t),errorCallback:X(t),completeCallback:O},M));F(r)&&y&&e.push(r)})),H((i=>i.map(((i,t)=>{var r;return Object.assign(Object.assign({},i),{uploadTask:null==e?void 0:e[t],fileState:i.fileState===b.INIT?b.LOADING:i.fileState,percentage:null!==(r=i.percentage)&&void 0!==r?r:0})}))))}),[U,H,R,y,Q,X,O,M]),ee=s((e=>{if(!e.target.files||0===e.target.files.length)return;const{files:i}=e.target;N([...i])>0&&(Z(!0),D(!0))}),[N,Z]),ie=s((()=>{Z(!1),H([])}),[H,Z]),te=s((e=>()=>{const{fileState:i,uploadTask:t}=U[e];"loading"===i&&F(t)&&(m.cancel(t),G(!1));const r=U.filter(((i,t)=>t!==e));H(r)}),[U,H]),re=s((e=>i=>{if(0===i.trim().length)return;const t=[...U],r=U[e],s=n(i,r.file.name);t[e]=Object.assign(Object.assign({},r),{name:i,fileState:s?b.INIT:b.ERROR,fileErrors:s?void 0:l("Extension not allowed")}),H(t)}),[U,H]),se=s(((e,i)=>{H((t=>{const r=[...t],s=r[e],o=n(s.name,s.file.name)?b.INIT:b.ERROR,m=i===b.INIT?o:i;return r[e]=Object.assign(Object.assign({},s),{fileState:m}),r}))}),[H]),oe=s((e=>()=>{se(e,b.INIT)}),[se]),me=s((e=>i=>{se(e,b.EDITING)}),[se]);r((()=>{T&&A&&!K&&(_(),D(!1))}),[T,_,A,K]);const le=i.useRef(),ae=null==h?void 0:h.join(),ne=o((()=>i.createElement(i.Fragment,null,i.createElement(c,{className:u.FileUploaderDropZoneButton,isDisabled:B,onClick:()=>{le.current.click(),le.current.value=null},size:"small"},l("Browse files")),i.createElement(d,null,i.createElement("input",{type:"file",tabIndex:-1,ref:le,onChange:ee,multiple:x,accept:ae})))),[B,ee,x,ae]);return z?i.createElement(g,{dropZone:i.createElement(j,Object.assign({},q,{inDropZone:V}),ne),fileStatuses:U,isLoading:B,isSuccessful:J,hasMaxFilesError:K,maxFileCount:w,onClear:ie,onFileClick:_,aggregatePercentage:W},null==U?void 0:U.map(((e,t)=>{var r;return i.createElement(f,{errorMessage:null==e?void 0:e.fileErrors,file:e.file,fileState:null==e?void 0:e.fileState,hasImage:null===(r=e.file)||void 0===r?void 0:r.type.startsWith("image/"),showImage:P,key:t,name:e.name,onCancel:te(t),onCancelEdit:oe(t),onPause:Y(t),onResume:$(t),onSaveEdit:re(t),onStartEdit:me(t),percentage:e.percentage,isResumable:y})}))):"button"===k?ne:i.createElement(j,Object.assign({},q,{inDropZone:V}),ne)}export{h as FileUploader};
